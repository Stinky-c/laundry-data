Project LaundryData {
  Note: '''
    requires Postgres >=18, and timescale latest version

    docker setup:
      https://www.tigerdata.com/docs/self-hosted/latest/install/installation-docker

    Fast joins using CTE:
      https://www.tigerdata.com/docs/tutorials/latest/cookbook#get-faster-join-queries-with-common-table-expressions

    csc api docs:
      https://web.archive.org/web/20240120071238/https://mycscgo.com/api/v1/docs/static/index.html#/Events/EventsController_events
      OT Location id: ***REMOVED***
        Res hall: ***REMOVED***
        Village red: ***REMOVED***
        Village blue: ***REMOVED***
        Village yellow: ***REMOVED***

      opaqueId is global machine id
  
    TODO:
      - Materialzed view? based on locations. A temp table for every location.
      - A machine history. Another table with machine id and room id in case a machine moves accorss rooms or locations
      - Primary key describes a little bit of the row. timestamp + hash(important value)

    Wishes:
      - backfilling
  '''
}

Table Laundry {
  id uuid [pk, note:'UUID v7 has the timestamp for timescale', default: `uuidv7()`]
  timestamp timestamptz [not null]
  global_machine_id int [not null,ref: < Machines.id]
  current_state MachineState [not null]

  // csc fields
  door_closed bool [not null]
  available bool [not null]
  not_available_reason string [note: 'TODO: find all reasons it may not be available', not null]
  time_remaining smallint [note: 'How long the machine will run for', not null]

  machine_settings json [note: 'Json because it is simple to handle and pg supports queries inside.', not null, default: `{}`]

  note: '''
    Every row repersents the state of a machine at a point in time.
    Will grow quickly if collectiong more than oregontech machines.

    Does not include a timestamp column, extract timestamp from uuid if needed.
      https://www.tigerdata.com/docs/api/latest/uuid-functions

    Discussion 1/29:
      Primary keys should have data related to the row. UUID is a random value with no relation to data.
      This is the "log" table, it has every part of the response for the api.

    Extra:
    create as a hypertable
      https://www.tigerdata.com/docs/use-timescale/latest/hypertables/hypertable-crud

      WITH (
        tsdb.hypertable,
        tsdb.orderby='time',
        tsdb.partition_column = 'id'
      )
  '''
}

Table Machines {
  id int [pk, note:'Global machine id', not null]
  room_id int [not null, ref: > Rooms.id]
  type MachineType [not null]

  csc_machine_id uuid [not null]
  // csc fields
  opaque_id uuid [not null]

  note:'''
    A machine may be replaced. 
    TODO: need mechanism to keep track of a spot at a location. Stickernumber vs Machine id
  '''
}

Table Rooms {
  id int [pk, not null]
  csc_id int [not null]
  location_id int [not null, ref: > Locations.id]
}

Table Locations {
  id int [pk, not null, note: "Global location id"]
  csc_id int [not null]
  address string [not null]
  timezone string [not null,note:'The timezone a location is in']
}

enum MachineState {
  pressStart
  running
  idle
  unknown
}

enum MachineType {
  washer
  dryer
}

Table ApiLog {
  id int [pk, not null]
  timestamp timestamptz [not null]
  code smallint [not null, note:'Http Response code']
  status ApiStatus [not null, default: ApiStauts.unknown, note: 'api status for timestamp. Need to fill in ApiStatus better']
  message string [not null, note: 'Will contain an error message']
}
// TODO: Fill in
enum ApiStatus {
  up
  down
  failure
  unknown
}

// Temps based on archived api docs
// WasherTemp, DryerTemp, MachineSettings (stored as json)

enum WasherTemp {
  cold
  warm
  host
}

enum DryerTemp {
  high_temp // high-temp
  med_temp // med-temp
  low_temp // low-temp
  no_temp // no-temp
  delicates
}

enum MachineSoil {
  normal
  light
  medium
  heavy
}

enum MachineCycle {
  normal
  perm_press // perm-press
  delicates
}

enum CSCTechnology {
  CSCGo
  DI
}
